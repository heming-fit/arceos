# 叶正楠部分

## 摘要

我是来自中国地质大学（武汉）的叶正楠，是一名硬件专业学生，很高兴能够参与到这次项目二的开发当中。我主要完成的是最后项目实战的硬件相关实现，具体内容如下：

* `arceos`相关：在系统的`axconfig`->`axhal`->`arceos_api`->`axstd`上创建相关函数传递，最后可在应用中使用`std::hal`使用。
* 硬件相关：需要根据开发版手册和`gpio`外设手册了解寄存器功能和位置，梳理整个运行流程。
* 具体实现：使用`tock_registers`从手册实现具体代码，顺带编写测试程序。

## `arceos`相关

具体路径如前文所述，下面是每个部分的具体作用和编程细节：

* `axconfig`：该模块提供不同环境下的设置，一般硬件的相关设置在不同运行平台都不互通。具体需要设置`/platforms/aarch64-bsta1000b.toml`：

  ```toml
  # gpio0
  gpio0-paddr = "0x20010000"
  # gpio1
  gpio1-paddr = "0x20011000"
  lock-paddr = "0x70038000"
  ```

* `axhal`：在这里提供硬件相关操作对象的初始化。比如将硬件的地址传给程序和初始化一些控制对象。和前者一样不同平台需要不同的适配。具体的初始化写在`/modules/axhal/src/platform/aarch64_bsta1000b/mod.rs`模块，在夫模块通过`pub use`暴露具体函数。
* `arceos_api`：在这里的可能起到统一不同平台的作用，但对于本次使用场景基本没必要做更多适配，未来可能可以在这里给模块套上`feature`。
* `axstd`：同理。

具体编程细节较为简单，可以照着已有的代码迁移而来。

## 硬件相关

首先从`dw_apb_gpio`的名称可以看出，该设备通过`apb`与芯片沟通，所以应该使用地址访问对应设备寄存器进行操作。相关地址需要关注两个地方，开发板将具体功能和引脚复用放在了两处。

以49-52引脚为例，根据手册，32-63脚属于`gpio0`的`portb`部分，使用`0xc0038000`进行端口复用（该地址似乎在开发板上有映射，实际上是使用`0x70038000`，这部分需要在开发板的`linux`固件开发手册上找到）。其中49-50使用偏移为`0x00`的寄存器，51-52使用偏移为`0x10`的寄存器，这些内容可以在引脚复用的表格中找到。实际上似乎默认的功能就是`gpio`

设置引脚功能后就可以开始操作功能寄存器了，根据开发板的规格书，`gpio0`的寄存器被映射在`0x20010000`中。而根据`dw_apb_gpio`的规格书，使用`portb`的引脚具体需要使用三个寄存器，具体名字是`ctl, ddr, dr`。`ctl`设置引脚的软件/硬件模式，我们需要使用端口的数字输出功能则需要设置为软件模式；`ddr`设置引脚的输入输出模式；`dr`设置引脚的高低电平。

## 具体实现

这部分内容的重点是根据手册编写寄存器结构体和寄存器比特位结构体。前者暴露寄存器的读写操作，需要地址偏移，寄存器宽度和比特位机构体类型。否则能让寄存器的读写更加人类可读，在传统嵌入式编程中我们通过二进制的逻辑操作将寄存器的读写精确到位。而设置比特位结构体后能够更加直观的了解到读写的具体位置，避免检查程序时频繁核对手册，下面是具体代码：

```rust
register_structs! {
    LOCKRegs {
        (0x0000 => aon_pmm_reg_0: ReadWrite<u32, aon_0::Register>),
        (0x0004 => _reserved0),// 库要求暂时不用的寄存器需要以 _reserved*的形式填充
        (0x0008 => _reserved1),
        (0x000C => _reserved2),
        (0x0010 => aon_pmm_reg_4: ReadWrite<u32, aon_4::Register>),
        (0x0014 => @END),
    }
}
```

```rust
register_bitfields! [
    u32,
    /// 设置引脚复用
    aon_0 [
        GPIO49 OFFSET(25) NUMBITS(1) [
            A_URAT3_TXD = 0,
            GPIO = 1
        ],
        GPIO50 OFFSET(26) NUMBITS(1) [
            A_URAT3_RXD = 0,
            GPIO = 1
        ],
    ],
];
```

